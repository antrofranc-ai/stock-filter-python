<!doctype html>
<html>
 <head>
 
  <!-- Required meta tags -->
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <title>NSE Stock Filter - Saurav Saha</title>

  <!-- JQuery -->
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.serializeJSON/2.9.0/jquery.serializejson.js"></script>

  <!-- Bootstrap -->
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/css/bootstrap.min.css"/>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0/js/bootstrap.min.js"></script>

  <!-- core datatables -->
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.16/js/jquery.dataTables.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/1.10.16/js/dataTables.bootstrap4.min.js"></script>
 
  <!-- column re-order -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/colreorder/1.4.1/css/colReorder.dataTables.min.css"/>
  <script type="text/javascript" src="https://cdn.datatables.net/colreorder/1.4.1/js/dataTables.colReorder.min.js"></script>
  
  <!-- fixed columns and headers -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedcolumns/3.2.4/css/fixedColumns.dataTables.min.css"/>
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/fixedheader/3.1.3/css/fixedHeader.dataTables.min.css"/>
  <script type="text/javascript" src="https://cdn.datatables.net/fixedcolumns/3.2.4/js/dataTables.fixedColumns.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/fixedheader/3.1.3/js/dataTables.fixedHeader.min.js"></script>
  
  <!-- buttons (column visibility) -->
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.5.1/css/buttons.dataTables.min.css"/>
  <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.1/js/dataTables.buttons.min.js"></script>
  <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.5.1/js/buttons.colVis.min.js"></script>

  <!-- SocketIO -->
  <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>

  <script>
   $(document).ready(function() {

    var datatable = $('#stockTable').DataTable( {
     data: null,
     columns: [
      { data: "symbol" },
      { data: "open" },
      { data: "high" },
      { data: "low" },
      { data: "ltP" },
      { data: "ptsC" },
      { data: "per" },
      { data: "prevClose" },
      { data: "gapPer" }
     ],
     paging: false,
     colReorder: true,
     buttons: [
      'colvis'
     ]
    }); // end of DataTable

    // Move search input of table
    $(".dataTables_filter").appendTo("#searchBtn");

    var socket = io.connect('http://' + document.domain + ':' + location.port);
    socket.on('connect', function() {
        console.log('Connection established with server:')
        socket.emit('echo_test', 'Test Echo Payload');
    });
    socket.on('echo_test', function(data) {
        console.log('Echo message received:' + data)
    });

    $("#filterButton").click(function () {
        $('#stockTableContainer').hide();
        $("#loadingContainer").show();
        socket.emit('filter', $('#filterForm').serializeJSON());
    }); // end click

    $("#updateButton").click(function () {
        $('#stockTableContainer').hide();
        $("#loadingContainer").show();
        socket.emit('update', $('#filterForm').serializeJSON());
    }); // end click

    socket.on('stock_data', function (result) {
        if ($.isEmptyObject(result)) {
            console.log("Empty stock data obtained!!!");
        } else {
            var dataSet = JSON.parse(result);
            datatable.clear().rows.add(dataSet).draw();
        }
        $("#loadingContainer").hide();
        $('#stockTableContainer').show();
    });
    
    // Force click on filter button on startup
    $("#filterButton").click();

   } );
  </script>
 </head>

 <body>

  <div class="container-fluid">

        <h1>NSE Stock Filter</h1>

        <form id="filterForm">
            <div class="form-group row">
                <label class="col-sm-1 col-form-label">Price Filter</label>
                <div class="col-sm-2">
                    <input type="number" min="0" class="form-control" placeholder="Min Price" name="min_price">
                </div>
                <div class="col-sm-2">
                    <input type="number" min="0" class="form-control" placeholder="Max Price" name="max_price">
                </div>
            </div>
            <div class="form-group row">
                <label class="col-sm-1 col-form-label">Gap Filter</label>
                <div class="col-sm-2">
                    <input type="number" min="0" max="100" class="form-control" placeholder="Gap Up %" name="gap_up_per">
                </div>
                <div class="col-sm-2">
                    <input type="number" min="0" max="100" class="form-control" placeholder="Gap Down %" name="gap_down_per">
                </div>
            </div>
            <!--
                <div class="row">
                    Open - Low Same %: <input type="number" name="open_low_same_per">
                    Open - High Same %: <input type="number" name="open_high_same_per">
                </div>
                -->
            <div class="form-group row">
                <div class="col-sm-1">
                    <button id="filterButton" class="btn btn-primary" type="button">Apply Filter</button>
                </div>
                <div class="col-sm-1">
                    <button id="updateButton" class="btn btn-secondary" type="button">Update Data</button>
                </div>
                <div class="col-sm-10">
                    <span id="searchBtn" class="float-right" />
                </div>
            </div>
        </form>
  </div>

  <div id="loadingContainer" style="width:100%;display:none">
        <img src="https://static.wixstatic.com/media/a9eed7_df9e4b627aba427f94fe8107aeb85403~mv2.gif" alt="loading" height="226" width="320">
  </div>

  <div id="stockTableContainer" style="width:100%">
        <table id="stockTable" class="table table-striped table-bordered display" width="100%">
         <thead>
          <tr>
           <th>Symbol</th>
           <th>Open</th>
           <th>High</th>
           <th>Low</th>
           <th>LTP</th>
           <th>Change</th>
           <th>Change %</th>
           <th>Prev Close</th>
           <th>Gap %</th>
          </tr>
         </thead>
        </table>
    </div>

 </body>

</html>